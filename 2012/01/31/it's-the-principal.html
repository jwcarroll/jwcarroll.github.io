<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="favicon.ico">

    <title>It's The Principal... - Techno Fattie</title>

    <!-- Fonts -->
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C400italic%2C700" rel="stylesheet">
    <link href="http://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet">

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/bootstrap-social.css" rel="stylesheet">

    <!-- Styles -->
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/pygments/vs.css" rel="stylesheet">

    <!-- Loading bar -->
    <script src="/js/pace.min.js"></script>

    <!-- HTML5 shiv for IE8 support -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div id="secondary" class="col-sm-3 sidebar" style="display: none;">
      <aside>

        <div class="about">
          <h4>About Josh Carroll</h4>
          <p>Computer geek, husband, father, theologian. I rock out web sites. I work for <a href="http://www.wintellect.com/">Wintellect</a>.</p>
        </div>

        <div class="socialmedia">
          <h4>Connect</h4>
          <div class="socials-sidebar">
          
            <a class="btn btn-twitter" href="https://twitter.com/jwcarroll" title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          
            <a class="btn btn-linkedin" href="https://www.linkedin.com/in/jwcarroll" title="LinkedIn">
              <i class="fa fa-linkedin"></i>
            </a>
          
            <a class="btn btn-google-plus" href="https://www.google.com/+JoshCarrollW" title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          
            <a class="btn btn-github" href="https://github.com/jwcarroll" title="GitHub">
              <i class="fa fa-github"></i>
            </a>
          
          </div> <!-- /.socials-sidebar -->
        </div>
        
        <div class="tags">
          <h4>Tags</h4>
          <ul>
          
            <li>
              <a href="/tags/f%23.html" class="tag btn btn-tag btn-sm">f#</a>
            </li>
          
            <li>
              <a href="/tags/.net.html" class="tag btn btn-tag btn-sm">.net</a>
            </li>
          
            <li>
              <a href="/tags/c%23.html" class="tag btn btn-tag btn-sm">c#</a>
            </li>
          
            <li>
              <a href="/tags/data-sets.html" class="tag btn btn-tag btn-sm">data-sets</a>
            </li>
          
            <li>
              <a href="/tags/commentary.html" class="tag btn btn-tag btn-sm">commentary</a>
            </li>
          
            <li>
              <a href="/tags/qa.html" class="tag btn btn-tag btn-sm">qa</a>
            </li>
          
            <li>
              <a href="/tags/tdd.html" class="tag btn btn-tag btn-sm">tdd</a>
            </li>
          
            <li>
              <a href="/tags/unit-testing.html" class="tag btn btn-tag btn-sm">unit-testing</a>
            </li>
          
            <li>
              <a href="/tags/security.html" class="tag btn btn-tag btn-sm">security</a>
            </li>
          
            <li>
              <a href="/tags/wpf.html" class="tag btn btn-tag btn-sm">wpf</a>
            </li>
          
            <li>
              <a href="/tags/validation.html" class="tag btn btn-tag btn-sm">validation</a>
            </li>
          
            <li>
              <a href="/tags/programming.html" class="tag btn btn-tag btn-sm">programming</a>
            </li>
          
            <li>
              <a href="/tags/sarcasm.html" class="tag btn btn-tag btn-sm">sarcasm</a>
            </li>
          
            <li>
              <a href="/tags/stackoverflow.html" class="tag btn btn-tag btn-sm">stackoverflow</a>
            </li>
          
            <li>
              <a href="/tags/dynamic.html" class="tag btn btn-tag btn-sm">dynamic</a>
            </li>
          
            <li>
              <a href="/tags/powershell.html" class="tag btn btn-tag btn-sm">powershell</a>
            </li>
          
            <li>
              <a href="/tags/angular.html" class="tag btn btn-tag btn-sm">angular</a>
            </li>
          
            <li>
              <a href="/tags/dependency-injection.html" class="tag btn btn-tag btn-sm">dependency-injection</a>
            </li>
          
            <li>
              <a href="/tags/humor.html" class="tag btn btn-tag btn-sm">humor</a>
            </li>
          
          </ul>
        </div>
        
        <div class="sidebar-links">
         <h4><a href="/archives/">Archives</a></h4>
        </div>
        
        
        <div>
            <h4>You Might Also Like:</h4>
            
            <h5>
               <a href="/2011/04/08/unit-testing-and-declarative-security-part-2.html">Unit Testing and Declarative Security, Part 2</a>
            </h5>
            
            <h5>
               <a href="/2011/09/23/solving-ayende%27s-tax-woes.html">Solving Ayende's Tax Woes</a>
            </h5>
            
            <h5>
               <a href="/2010/06/25/extending-moq-using-extension-methods.html">Extending Moq Using Extension Methods</a>
            </h5>
            
            <h5>
               <a href="/2011/02/11/wpf-fancy-winforms.html">WPF != Fancy Winforms</a>
            </h5>
            
            <h5>
               <a href="/2011/02/09/unit-testing-and-declarative-security-part-1.html">Unit Testing and Declarative Security, Part 1</a>
            </h5>
            
        </div>
        
        
      </aside>
    </div> <!-- /#secondary -->

    <div id="primary" class="col-sm-12">
      <div class="content">
        
        <header class="header">
          <hgroup class="pull-left">
            <h1 class="site-title">
              <a rel="home" title="Techno Fattie" href="/">
                <i class="fa fa-code"></i> Techno Fattie
              </a>
            </h1>            
          </hgroup>
          <div id="togglesidebar" class="btn btn-primary pull-right">
            <i class="fa fa-bars"></i>
          </div>
        </header> <!-- /header -->

        

<section class="post">
 <header class="entry-header">
   <img class="entry-avatar" alt="Josh Carroll" height="52" width="52" src="http://www.gravatar.com/avatar/213ff080fa03648f0b71e4f4658a8046.png?s=52">
   <h1 class="entry-title"><a href="/2012/01/31/it%27s-the-principal.html">It's The Principal...</a></h1>
   <p class="entry-meta">
     Posted on <a class="entry-date" href="/archives/#january-2012">31 January 2012</a> | 
     By <a class="entry-author" href="/about/">Josh Carroll</a>
     
     | Tags 
     
     <a href="/tags/c%23.html" class="btn btn-default btn-xs">c#</a> 
     
     <a href="/tags/.net.html" class="btn btn-default btn-xs">.net</a> 
     
     <a href="/tags/security.html" class="btn btn-default btn-xs">security</a> 
     
     <a href="/tags/unit-testing.html" class="btn btn-default btn-xs">unit-testing</a> 
     
     <a href="/tags/tdd.html" class="btn btn-default btn-xs">tdd</a> 
     
     
   </p>
 </header>
 <div class="entry-description">
   In ancient times... at least according to web standards, I wrote a <a href="http://technofattie.blogspot.com/2011/02/unit-testing-and-declarative-security.html"">couple of posts</a> about <a href="http://technofattie.blogspot.com/2011/04/unit-testing-and-declarative-security.html">unit testing with declarative security attributes</a>. It turns out that while using declarative security is pretty awesome, it's clear <i>nobody</i>&nbsp;was thinking about people doing TDD :(<div><br /></div><div>Getting around this was easy enough by simply overriding the <a href="http://msdn.microsoft.com/en-us/library/system.threading.thread.currentprincipal.aspx">Principal</a> using the built in <a href="http://msdn.microsoft.com/en-us/library/system.security.principal.genericprincipal.aspx">GenericPrincipal</a> and <a href="http://msdn.microsoft.com/en-us/library/system.security.principal.genericidentity.aspx">GenericIdentity</a> classes. We even refactored the security setup code into the Initialize method for our unit tests. However, <b>we still had to think about security for every test class!</b></div><div><b><br /></b></div><div>I can tell you right now that that is a big fat suck! I don't want to see <i>any</i>&nbsp;security related code in my unit test because <b>I'm not testing security right now!</b>&nbsp;What I really want is for my test to look like this and just work.</div><div><br /></div><div><pre><code>[TestMethod]<br />public void ShouldGetSuperSecretFromAgent()<br />{<br />    var agent = new SecretAgent();<br /><br />    //This line will esplode!!!<br />    var secret = agent.GetSuperSecretStuff();<br /><br />    Assert.IsNotNull(secret);<br />}<br /></code></pre></div><div><br /></div><div>Fortunately, we still have one last trick up our sleeve that we can use to solve our problem once and for all. Writing a custom implementation of <a href="http://msdn.microsoft.com/en-us/library/system.security.principal.iprincipal.aspx">IPrincipal</a> and <a href="http://msdn.microsoft.com/en-us/library/system.security.principal.iidentity.aspx">IIdentity</a>. This is so braindead simple, that I'm not even going to explain it... just show you the code.</div><div><br /></div><div><pre><code><br />public class StubPrincipal: IPrincipal, IIdentity<br />{<br />    public StubPrincipal(String name = "TestUser", Boolean isAuthenticated = true, String authenticationType = "Fake")<br />    {<br />        Name = name;<br />        IsAuthenticated = isAuthenticated;<br />        AuthenticationType = authenticationType;<br />    }<br /><br />    //IPrincipal Members<br />    public IIdentity Identity<br />    {<br />        get { return this; }<br />    }<br /><br />    public bool IsInRole(string role)<br />    {<br />        return true;<br />    }<br /><br />    //IIdentity Members<br />    public string AuthenticationType { get; set; }<br /><br />    public bool IsAuthenticated { get; set; }<br /><br />    public string Name { get; set; }<br />}</code></pre></div><div><br /></div><div>This still leaves the business of wiring it all up. Since the whole point of this refactoring was to <i>not</i>&nbsp;have to worry about doing this for every test!</div><div><br /></div><div><b>All your base class are belong to us!</b></div><div><b><br /></b></div><div>The simplest approach I can think of is to create a base class that will wire up your custom <b>StubPrincipal</b> object in the constructor, and then derive all your test classes from it. Again, this is so braindead simple... just look at the code.</div><div><br /></div><div><pre><code><br />public class SecurityEnabledTest<br />{<br />    protected StubPrincipal Principal = new StubPrincipal();<br /><br />    public SecurityEnabledTest()<br />    {<br />        Thread.CurrentPrincipal = Principal;<br />    }<br />}<br /></code></pre></div><div><br /></div><div>And now our goal above is reached with one tiny modification.</div><div><br /></div><div><pre><code><br />[TestClass]<br />public class SecretAgentBehavior_UsingBaseClass: SecurityEnabledTest<br />{<br />    [TestMethod]<br />    [Description("Test relying on base class to set principal")]<br />    public void ShouldGetSuperSecretFromAgent()<br />    {<br />        var agent = new SecretAgent();<br /><br />        //It works... WOOT!<br />        var secret = agent.GetSuperSecretStuff();<br /><br />        Assert.IsNotNull(secret);<br />    }<br />}<br /></code></pre></div><div><br /></div><div>Voila! Now you can go on your merry little way and focus on the actual method behavior instead of the security meta-data.</div><div><br /></div><div><b>But Wait! There is even more awesome!</b></div><div><b><br /></b></div><div>If you are thinking to yourself "Ok, that is great dude, but what if I actually want to test MY FREAKING SECURITY!"</div><div><br /></div><div>I've got you covered. Here is a slightly <a href="https://gist.github.com/1708922">more robust Principal object</a> that will give you a lot more control over how it behaves, which should cover any testing scenario you can think of. It allows you to add roles, and has three modes of operation:</div><div><ol><li>Always Return True</li><li>Whitelist</li><ol><li>This is how a normal principal operates. If the role is in the list, then you get access.</li></ol><li>Blacklist</li><ol><li>This works opposite to a normal principal. If the role is in the list, then you get denied access. This is useful for when there are multiple roles needed to perform an action (think nested calls), and you want to see how your code behaves when the user <i>doesn't</i>&nbsp;have one of them.</li></ol></ol><div>In the end I hope this helps unit testing efforts, and maybe demystifies the Principal/Identity objects a little bit. You can even use these same techniques to write your own custom security Principal for actual production uses. The concepts are identical.</div></div><div><br /></div><div>Cheers,</div><div>Josh</div>

 </div>
 

<div class="footer">
    <h4>Share This Post</h4>

    <div class="socials-footer">
        <a class="btn btn-twitter" href="http://twitter.com/share?text=It's The Principal... by @jwcarroll&url=http://www.technofattie.com/2012/01/31/it%27s-the-principal.html"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
            <i class="fa fa-twitter"></i>
        </a>
        <a class="btn btn-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://www.technofattie.com/2012/01/31/it%27s-the-principal.html"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
            <i class="fa fa-facebook"></i>
        </a>
        <a class="btn btn-google-plus" href="https://plus.google.com/share?url=http://www.technofattie.com/2012/01/31/it%27s-the-principal.html"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
            <i class="fa fa-google-plus"></i>
        </a>
    </div>
</div>
</section>

<div class="comments">
 <div id="disqus_thread"></div>
 <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'technofattie'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
 </script>
 <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

        <footer class="footer">
          <p>© <a href="/about/">Josh Carroll</a> 2014. All right reserved.</p>
          <div class="socials-footer">
          
            <a class="btn btn-twitter" href="https://twitter.com/jwcarroll" title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          
            <a class="btn btn-linkedin" href="https://www.linkedin.com/in/jwcarroll" title="LinkedIn">
              <i class="fa fa-linkedin"></i>
            </a>
          
            <a class="btn btn-google-plus" href="https://www.google.com/+JoshCarrollW" title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          
            <a class="btn btn-github" href="https://github.com/jwcarroll" title="GitHub">
              <i class="fa fa-github"></i>
            </a>
          
          </div> <!-- /.socials-footer -->
        </footer> <!-- /footer -->

      </div>
    </div> <!-- /#primary -->

    <!-- Scripts -->
    <script src="/js/jquery-1.11.0.min.js"></script>
    <script src="/js/custom.js"></script>

  </body>
</html>