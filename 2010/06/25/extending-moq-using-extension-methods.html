<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <title>Extending Moq Using Extension Methods - Techno Fattie</title>

    <!-- Fonts -->
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C400italic%2C700" rel="stylesheet">
    <link href="http://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet">

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/bootstrap-social.css" rel="stylesheet">

    <!-- Styles -->
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/pygments/syntax.css" rel="stylesheet">

    <!-- Loading bar -->
    <script src="/js/pace.min.js"></script>

    <!-- HTML5 shiv for IE8 support -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <![endif]-->

    
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47962022-1', 'technofattie.com');
    ga('send', 'pageview');

</script>
    
  </head>

  <body>

    <div id="secondary" class="col-sm-3 sidebar" style="display: none;">
      <aside>

        <div class="about">
          <h4>About Josh Carroll</h4>
          <p>Computer geek, husband, father, theologian. I rock out web sites. I work for <a href="http://www.wintellect.com/">Wintellect</a>.</p>
        </div>

        <div class="socialmedia">
          <h4>Connect</h4>
          <div class="socials-sidebar">
          
            <a class="btn btn-twitter" href="https://twitter.com/jwcarroll" title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          
            <a class="btn btn-linkedin" href="https://www.linkedin.com/in/jwcarroll" title="LinkedIn">
              <i class="fa fa-linkedin"></i>
            </a>
          
            <a class="btn btn-google-plus" href="https://www.google.com/+JoshCarrollW" title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          
            <a class="btn btn-github" href="https://github.com/jwcarroll" title="GitHub">
              <i class="fa fa-github"></i>
            </a>
          
          </div> <!-- /.socials-sidebar -->
        </div>
        
        <div class="tags">
          <h4>Tags</h4>
          <ul>
          
            <li>
              <a href="/tags/f%23.html" class="tag btn btn-tag btn-sm">f#</a>
            </li>
          
            <li>
              <a href="/tags/dot-net.html" class="tag btn btn-tag btn-sm">dot-net</a>
            </li>
          
            <li>
              <a href="/tags/c%23.html" class="tag btn btn-tag btn-sm">c#</a>
            </li>
          
            <li>
              <a href="/tags/data-sets.html" class="tag btn btn-tag btn-sm">data-sets</a>
            </li>
          
            <li>
              <a href="/tags/commentary.html" class="tag btn btn-tag btn-sm">commentary</a>
            </li>
          
            <li>
              <a href="/tags/qa.html" class="tag btn btn-tag btn-sm">qa</a>
            </li>
          
            <li>
              <a href="/tags/tdd.html" class="tag btn btn-tag btn-sm">tdd</a>
            </li>
          
            <li>
              <a href="/tags/unit-testing.html" class="tag btn btn-tag btn-sm">unit-testing</a>
            </li>
          
            <li>
              <a href="/tags/security.html" class="tag btn btn-tag btn-sm">security</a>
            </li>
          
            <li>
              <a href="/tags/wpf.html" class="tag btn btn-tag btn-sm">wpf</a>
            </li>
          
            <li>
              <a href="/tags/validation.html" class="tag btn btn-tag btn-sm">validation</a>
            </li>
          
            <li>
              <a href="/tags/programming.html" class="tag btn btn-tag btn-sm">programming</a>
            </li>
          
            <li>
              <a href="/tags/sarcasm.html" class="tag btn btn-tag btn-sm">sarcasm</a>
            </li>
          
            <li>
              <a href="/tags/stackoverflow.html" class="tag btn btn-tag btn-sm">stackoverflow</a>
            </li>
          
            <li>
              <a href="/tags/dynamic.html" class="tag btn btn-tag btn-sm">dynamic</a>
            </li>
          
            <li>
              <a href="/tags/powershell.html" class="tag btn btn-tag btn-sm">powershell</a>
            </li>
          
            <li>
              <a href="/tags/angular.html" class="tag btn btn-tag btn-sm">angular</a>
            </li>
          
            <li>
              <a href="/tags/javascript.html" class="tag btn btn-tag btn-sm">javascript</a>
            </li>
          
            <li>
              <a href="/tags/dependency-injection.html" class="tag btn btn-tag btn-sm">dependency-injection</a>
            </li>
          
            <li>
              <a href="/tags/humor.html" class="tag btn btn-tag btn-sm">humor</a>
            </li>
          
            <li>
              <a href="/tags/jekyll.html" class="tag btn btn-tag btn-sm">jekyll</a>
            </li>
          
            <li>
              <a href="/tags/github.html" class="tag btn btn-tag btn-sm">github</a>
            </li>
          
            <li>
              <a href="/tags/bootstrap.html" class="tag btn btn-tag btn-sm">bootstrap</a>
            </li>
          
            <li>
              <a href="/tags/introspection.html" class="tag btn btn-tag btn-sm">introspection</a>
            </li>
          
            <li>
              <a href="/tags/ng-transform.html" class="tag btn btn-tag btn-sm">ng-transform</a>
            </li>
          
          </ul>
        </div>
        
        <div class="sidebar-links">
         <h4><a href="/archives/">Archives</a></h4>
        </div>
        
        
        <div>
            <h4>You Might Also Like:</h4>
            
            <h5>
               <a href="/2011/02/11/wpf-fancy-winforms.html">WPF != Fancy Winforms</a>
            </h5>
            
            <h5>
               <a href="/2011/09/23/solving-ayende%27s-tax-woes.html">Solving Ayende's Tax Woes</a>
            </h5>
            
            <h5>
               <a href="/2014/02/15/angular-powered-text-transformations.html">Angular Powered Text Transformations - Part 1</a>
            </h5>
            
            <h5>
               <a href="/2011/04/08/unit-testing-and-declarative-security-part-2.html">Unit Testing and Declarative Security, Part 2</a>
            </h5>
            
            <h5>
               <a href="/2012/01/31/it%27s-the-principal.html">It's The Principal...</a>
            </h5>
            
        </div>
        
        
      </aside>
    </div> <!-- /#secondary -->

    <div id="primary" class="col-sm-12">
      <div class="content">
        
        <header class="header">
          <hgroup class="pull-left">
            <h1 class="site-title">
              <a rel="home" title="Techno Fattie" href="/">
                <i class="fa fa-code"></i> Techno Fattie
              </a>
            </h1>            
          </hgroup>
          <div id="togglesidebar" class="btn btn-primary pull-right">
            <i class="fa fa-bars"></i>
          </div>
        </header> <!-- /header -->

        

<section class="post">
 <header class="entry-header">
   <img class="entry-avatar" alt="Josh Carroll" height="52" width="52" src="http://www.gravatar.com/avatar/213ff080fa03648f0b71e4f4658a8046.png?s=52">
   <h1 class="entry-title"><a href="/2010/06/25/extending-moq-using-extension-methods.html">Extending Moq Using Extension Methods</a></h1>
   <p class="entry-meta">
     Posted on <a class="entry-date" href="/archives/#june-2010">25 June 2010</a> | 
     By <a class="entry-author" href="/about/">Josh Carroll</a>
     
     | Tags 
     
     <a href="/tags/c%23.html" class="btn btn-default btn-xs">c#</a> 
     
     <a href="/tags/dot-net.html" class="btn btn-default btn-xs">dot-net</a> 
     
     <a href="/tags/tdd.html" class="btn btn-default btn-xs">tdd</a> 
     
     <a href="/tags/unit-testing.html" class="btn btn-default btn-xs">unit-testing</a> 
     
     
   </p>
 </header>
 <div class="entry-description">
   <p>If you regularly use <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a>, then you are familiar with the concept of mocking. If you don&#39;t use TDD, then you need to slap yourself and apologize to <a href="http://www.objectmentor.com/omTeam/martin_r.html">Bob Martin</a>, <a href="http://www.objectmentor.com/omTeam/feathers_m.html">Michael Feathers</a> and <a href="http://www.objectmentor.com/omTeam/jeffries_r.html">Ron Jeffries</a> immediately. I&#39;ll wait here...</p>

<p>While I would argue you should begin your TDD journey by <a href="http://blog.objectmentor.com/articles/2009/10/28/manual-mocking-resisting-the-invasion-of-dots-and-parentheses">writing your own mocks</a>; using a framework will certainly make like easier in many instances and allow you to focus on the tests themselves.</p>

<p>I was a <a href="http://www.ayende.com/projects/rhino-mocks.aspx">RhinoMocks</a> guy for a long time, but have recently converted to <a href="http://code.google.com/p/moq/">Moq</a>... AND I LOVE IT!!! Moq is simple and easy to use, and doesn&#39;t get in the way of the intent of your tests. That being said, there are certain scenarios you run into with any framework that you end up coding around, and sometimes that <em>does</em> get in the way of your what you trying to say with your test.</p>

<p>Moq allows for a pretty simple syntax when you want to set up a return value on a mocked type.</p>

<div class="highlight"><pre><code class="c#"><span class="kt">var</span> <span class="n">mockService</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IReturnStuff</span><span class="p">&gt;();</span>
<span class="n">mockService</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">svc</span> <span class="p">=&gt;</span> <span class="n">svc</span><span class="p">.</span><span class="n">SomeMethodCall</span><span class="p">()).</span><span class="n">Returns</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">);</span>
</code></pre></div>

<p>Pretty sweet so far, and that works 99% of the time. But... what about a scenario where we want to return different values on successive calls to that method. I can think of a lot of situations where, in the absence of formal eventing, you want your code to test some value until it meets a certain criteria. You might be polling a web service for status updates, or checking a database to see if a record has been written. Whatever the case may be, it <em>will</em> come up.</p>

<p>So, for illustration purposes, let&#39;s make up one such example. Suppose we wanted to ask a service for a specified set of values, but the return types could be varied. Perhaps we only care about some subset of those values, and want to test that our code correctly deals with variable data.</p>

<p>We have our service contract:</p>

<div class="highlight"><pre><code class="c#"><span class="k">public</span> <span class="k">interface</span> <span class="n">IReturnStuff</span><span class="p">{</span>
   <span class="n">String</span> <span class="nf">ReturnAString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>Next we have our consuming class (the subject under test):</p>

<div class="highlight"><pre><code class="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">UsesReturnedStuff</span><span class="p">{</span>
    <span class="k">public</span> <span class="n">IReturnStuff</span> <span class="n">ReturnStuff</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">private</span> <span class="n">Regex</span> <span class="n">Filter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">UsesReturnedStuff</span><span class="p">(</span><span class="n">IReturnStuff</span> <span class="n">returnStuff</span><span class="p">){</span>
        <span class="n">ReturnStuff</span> <span class="p">=</span> <span class="n">returnStuff</span><span class="p">;</span>
        <span class="n">Filter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="p">(</span><span class="s">&quot;(the|quick|brown|fox|hello|world)(:Pu)?&quot;</span><span class="p">,</span> <span class="n">RegexOptions</span><span class="p">.</span><span class="n">IgnoreCase</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="n">GetStuff</span><span class="p">(</span><span class="n">Int32</span> <span class="n">times</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">stuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;();</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;</span> <span class="n">times</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">newStuff</span> <span class="p">=</span> <span class="n">ReturnStuff</span><span class="p">.</span><span class="n">ReturnAString</span><span class="p">();</span>

            <span class="k">if</span><span class="p">(</span><span class="n">Filter</span><span class="p">.</span><span class="n">IsMatch</span><span class="p">(</span><span class="n">newStuff</span><span class="p">))</span>
                <span class="n">stuff</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">newStuff</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">stuff</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>As you can see we have a pretty basic setup here that uses a white-list approach to building up a list. We want to write some tests to mock this behavior. If we wanted two different return values when this method is called, we might instinctively write a test like this:</p>

<div class="highlight"><pre><code class="c#"><span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">LastSetupWins</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">mockReturnStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IReturnStuff</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">usesStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UsesReturnedStuff</span><span class="p">(</span><span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

    <span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">svc</span> <span class="p">=&gt;</span> <span class="n">svc</span><span class="p">.</span><span class="n">ReturnAString</span><span class="p">()).</span><span class="n">Returns</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span>
    <span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">svc</span> <span class="p">=&gt;</span> <span class="n">svc</span><span class="p">.</span><span class="n">ReturnAString</span><span class="p">()).</span><span class="n">Returns</span><span class="p">(</span><span class="s">&quot;World!&quot;</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">stuff</span> <span class="p">=</span> <span class="n">usesStuff</span><span class="p">.</span><span class="n">GetStuff</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>

    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;Hello World!&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">stuff</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()));</span>
<span class="p">}</span>
</code></pre></div>

<p>If you couldn&#39;t already tell from the name of the test method, this won&#39;t work as the last return value to be Setup wins. The output from this test will produce the text:
<blockquote>&quot;World! World!&quot;</blockquote>Not so great, but the Moq documentation gives us a workaround by using a callback method. A little bit of refactoring and Voila!</p>

<div class="highlight"><pre><code class="c#"><span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">SetupWithCallback</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">mockReturnStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IReturnStuff</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">usesStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UsesReturnedStuff</span><span class="p">(</span><span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">returnValues</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="s">&quot;Hello&quot;</span><span class="p">,</span> <span class="s">&quot;World!&quot;</span><span class="p">};</span>
    <span class="kt">var</span> <span class="n">numCalls</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

    <span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">svc</span> <span class="p">=&gt;</span> <span class="n">svc</span><span class="p">.</span><span class="n">ReturnAString</span><span class="p">())</span>
        <span class="p">.</span><span class="n">Returns</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">returnValues</span><span class="p">[</span><span class="n">numCalls</span><span class="p">])</span>
        <span class="p">.</span><span class="n">Callback</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">numCalls</span><span class="p">++);</span>

    <span class="kt">var</span> <span class="n">stuff</span> <span class="p">=</span> <span class="n">usesStuff</span><span class="p">.</span><span class="n">GetStuff</span><span class="p">(</span><span class="n">returnValues</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;Hello World!&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">stuff</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()));</span>
<span class="p">}</span>
</code></pre></div>

<p>Here we are taking advantage of anonymous methods and closures to essentially keep feeding our Mock service it&#39;s next value. This works, but... yuck! Reading this test is not very clear, and it gets in the way of the intent.
Since we are supposed to refactor our test code too, lets move the ugly bits out into a private method, and re-write our test again.</p>

<div class="highlight"><pre><code class="c#"><span class="k">private</span> <span class="k">static</span> <span class="n">Int32</span> <span class="nf">SetupMany</span><span class="p">(</span><span class="n">Mock</span><span class="p">&lt;</span><span class="n">IReturnStuff</span><span class="p">&gt;</span> <span class="n">mock</span><span class="p">,</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IReturnStuff</span><span class="p">,</span> <span class="n">String</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">,</span> <span class="k">params</span> <span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">numCalls</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

    <span class="n">mock</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Returns</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">[</span><span class="n">numCalls</span><span class="p">])</span>
        <span class="p">.</span><span class="n">Callback</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">numCalls</span><span class="p">++);</span>

    <span class="k">return</span> <span class="n">args</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">SetupWithExtractedMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">mockReturnStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IReturnStuff</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">usesStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UsesReturnedStuff</span><span class="p">(</span><span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">calls</span> <span class="p">=</span> <span class="n">SetupMany</span><span class="p">(</span><span class="n">mockReturnStuff</span><span class="p">,</span>
                          <span class="n">svc</span> <span class="p">=&gt;</span> <span class="n">svc</span><span class="p">.</span><span class="n">ReturnAString</span><span class="p">(),</span>
                          <span class="s">&quot;Hello&quot;</span><span class="p">,</span> <span class="s">&quot;World!&quot;</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">stuff</span> <span class="p">=</span> <span class="n">usesStuff</span><span class="p">.</span><span class="n">GetStuff</span><span class="p">(</span><span class="n">calls</span><span class="p">);</span>

    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;Hello World!&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">stuff</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()));</span>
<span class="p">}</span>
</code></pre></div>

<p>This is good. We haven&#39;t lost any functionality, but the intent of the test is much clearer. There is less friction because you can read the code and understand what it is doing pretty quickly without having to &quot;decipher&quot; the meaning.
Now, this is all fine and good, but I am likely to run into this same scenario more than once. What I would really love to have is a SetupMany() method that was built into Moq. A method I could call directly on the mocked object. Well... starting with C# 3.0 Extension Methods give us the ability to do just that. With a little work, we should be able to create a very generic extension to give us the desired behavior.</p>

<div class="highlight"><pre><code class="c#"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MoqExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">SetupMany</span><span class="p">&lt;</span><span class="n">TSvc</span><span class="p">,</span> <span class="n">TReturn</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">TSvc</span><span class="p">&gt;</span> <span class="n">mock</span><span class="p">,</span>
        <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TSvc</span><span class="p">,</span> <span class="n">TReturn</span><span class="p">&gt;&gt;</span> <span class="n">expression</span><span class="p">,</span>
        <span class="k">params</span> <span class="n">TReturn</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TSvc</span> <span class="p">:</span> <span class="k">class</span>
    <span class="err">{</span>
        <span class="kt">var</span> <span class="n">numCalls</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="n">mock</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
            <span class="p">.</span><span class="n">Returns</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">numCalls</span> <span class="p">&lt;</span> <span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">?</span> <span class="n">args</span><span class="p">[</span><span class="n">numCalls</span><span class="p">]</span> <span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">])</span>
            <span class="p">.</span><span class="n">Callback</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">numCalls</span><span class="p">++);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Ok, so I know the method signature looks pretty scary. Just don&#39;t stare at it long enough or you will go blind! The extra bit with the Ternary operator is a bit of error checking to prevent you from running over the bounds of the array. If you call the method more times than available arguments, it will simply keep returning the last argument in the list.
Refactoring our test one last time gives us an even cleaner syntax that works with any return type. The second test merely demonstrates the &quot;sticky&quot; final value being returned over and over.</p>

<div class="highlight"><pre><code class="c#"><span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">SetupWithGenericExtensionMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">mockReturnStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">IReturnStuff</span><span class="p">&amp;</span><span class="n">gt</span><span class="p">;();</span>
    <span class="kt">var</span> <span class="n">usesStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UsesReturnedStuff</span><span class="p">(</span><span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

    <span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">SetupMany</span><span class="p">(</span><span class="n">svc</span> <span class="p">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">svc</span><span class="p">.</span><span class="n">ReturnAString</span><span class="p">(),</span> <span class="s">&quot;Hello&quot;</span><span class="p">,</span> <span class="s">&quot;World!&quot;</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">stuff</span> <span class="p">=</span> <span class="n">usesStuff</span><span class="p">.</span><span class="n">GetStuff</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>

    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;Hello World!&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">stuff</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()));</span>
<span class="p">}</span>

<span class="na">[Test]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">SetupWithLotsOfParams</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">mockReturnStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IReturnStuff</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">usesStuff</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UsesReturnedStuff</span><span class="p">(</span><span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

    <span class="n">mockReturnStuff</span><span class="p">.</span><span class="n">SetupMany</span><span class="p">(</span><span class="n">svc</span> <span class="p">=&gt;</span> <span class="n">svc</span><span class="p">.</span><span class="n">ReturnAString</span><span class="p">(),</span>
                              <span class="s">&quot;the&quot;</span><span class="p">,</span><span class="s">&quot;quick&quot;</span><span class="p">,</span><span class="s">&quot;brown&quot;</span><span class="p">,</span><span class="s">&quot;fox&quot;</span><span class="p">,</span><span class="s">&quot;jumps&quot;</span><span class="p">,</span><span class="s">&quot;over&quot;</span><span class="p">,</span><span class="s">&quot;the&quot;</span><span class="p">,</span><span class="s">&quot;fence&quot;</span><span class="p">,</span><span class="s">&quot;hello!&quot;</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">stuff</span> <span class="p">=</span> <span class="n">usesStuff</span><span class="p">.</span><span class="n">GetStuff</span><span class="p">(</span><span class="m">11</span><span class="p">);</span>

    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;the quick brown fox the hello! hello! hello!&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">stuff</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()));</span>
<span class="p">}</span>
</code></pre></div>

<p>And there you have it. Extending the Moq API without having to actually go in and modify the source. Hopefully this will save you a headache or two in the future.</p>

 </div>
 

<div class="footer">
    <h4>Share This Post</h4>

    <div class="socials-footer">
        <a class="btn btn-twitter" href="http://twitter.com/share?text=Extending Moq Using Extension Methods by @jwcarroll&url=http://www.technofattie.com/2010/06/25/extending-moq-using-extension-methods.html"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
            <i class="fa fa-twitter"></i>
        </a>
        <a class="btn btn-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://www.technofattie.com/2010/06/25/extending-moq-using-extension-methods.html"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
            <i class="fa fa-facebook"></i>
        </a>
        <a class="btn btn-google-plus" href="https://plus.google.com/share?url=http://www.technofattie.com/2010/06/25/extending-moq-using-extension-methods.html"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
            <i class="fa fa-google-plus"></i>
        </a>
    </div>
</div>
</section>

<div class="comments">
 <div id="disqus_thread"></div>
 <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'technofattie'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
 </script>
 <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

        <footer class="footer">
          <p>© <a href="/about/">Josh Carroll</a> 2014. All right reserved.</p>
          <div class="socials-footer">
          
            <a class="btn btn-twitter" href="https://twitter.com/jwcarroll" title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          
            <a class="btn btn-linkedin" href="https://www.linkedin.com/in/jwcarroll" title="LinkedIn">
              <i class="fa fa-linkedin"></i>
            </a>
          
            <a class="btn btn-google-plus" href="https://www.google.com/+JoshCarrollW" title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          
            <a class="btn btn-github" href="https://github.com/jwcarroll" title="GitHub">
              <i class="fa fa-github"></i>
            </a>
          
          </div> <!-- /.socials-footer -->
        </footer> <!-- /footer -->

      </div>
    </div> <!-- /#primary -->

    <!-- Scripts -->
    <script src="/js/jquery-1.11.0.min.js"></script>
    <script src="/js/custom.js"></script>

  </body>
</html>